<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Crowd Interactive Tech Blog :: Blog</title>
  <link rel="stylesheet" href="/stylesheets/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/stylesheets/print.css" type="text/css" media="print" />
  <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/skribit.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="screen" />
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for blog.crowdint.com" href="http://feeds.feedburner.com/CrowdInteractiveTechBlog" />
  <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
  
</head>
<body>
  <div class="container">
    <div id="empty-header">
      <a href="/"><img src="/images/logo_03.png" id="logoHead" width="227" height="74" alt="LogoHead" /></a>
    </div>
    <div class="span-24 append-bottom testGlow">
      <div class="round-top span-24">
        &nbsp;
      </div>
      <div id="white-body" class="span-24">
        <div class="left-side span-17">
          
<div class="post prepend-1">
  <h1><a href="/2010/11/05/controller-responders-in-rails-3.html">Controller responders in Rails 3</a></h1>
  <p class="author">
    <span class="date"><b>Nov 05</b><br />2010</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/1e7f8fb8733b6193cf3bdbc85693f515" class="avatar" alt="Avatar" /></div>
    <p>When Rails 3 was released I was expecting several changes, most of them had me excited. I was aware Rails 3 would be even more reliable and tied to it's main concept "Convention over configuration". What can I say? I'm believer!</p>

<p>Well, I'm impressed the most with the new even DRYer way Rails works with Controllers. Let me explain why.</p>

<p>Imagine you are creating a basic RESTFUL controller, you could start with:</p>

<div class="highlight"><pre><code class="bash">class VariantsController &lt; ApplicationController

  def index
    @variants <span class="o">=</span> Variant.all
  end
  
  def new
    @variant <span class="o">=</span> Variant.new
  end
  
  def create
    @variant <span class="o">=</span> Variant.new<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">])</span>
    <span class="k">if</span> @variant.save
      flash<span class="o">[</span>:notice<span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Fortunately it was saved!&quot;</span>
      redirect_to variant_path
    <span class="k">else</span>
<span class="k">      </span>render :action <span class="o">=</span>&gt; <span class="s2">&quot;new&quot;</span>
    end
  end
  .
  .
  .
</code></pre>
</div>


<p>Once you are finished, you will have the seven necessary actions (index, new, create, show, edit, update and destroy). Now imagine you have to respond to different MIME requests, like xml, json, html. So, in your controller you may have something like this:</p>

<div class="highlight"><pre><code class="bash">class VariantsController &lt; ApplicationController

  def index
    @users <span class="o">=</span> User.all
    respond_to <span class="k">do</span> |format|
      format.html
      format.xml <span class="o">{</span> render :xml <span class="o">=</span>&gt; @users <span class="o">}</span>
    end
  end
  .
  .
  .

  def create
    @variant <span class="o">=</span> Variant.new<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">])</span>
    respond_to <span class="k">do</span> |format|
      <span class="k">if</span> @user.save
        flash<span class="o">[</span>:notice<span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Fortunately it was saved!&#39;</span>
        format.html <span class="o">{</span> redirect_to variant_path<span class="o">)</span> <span class="o">}</span>
        format.xml <span class="o">{</span> render :xml <span class="o">=</span>&gt; @varian, :status <span class="o">=</span>&gt; :created, :location <span class="o">=</span>&gt; @variant <span class="o">}</span>
      <span class="k">else</span>
<span class="k">        </span>format.html <span class="o">{</span> render :action <span class="o">=</span>&gt; <span class="s2">&quot;new&quot;</span> <span class="o">}</span>
        format.xml <span class="o">{</span> render :xml <span class="o">=</span>&gt; @variant.errors, :status <span class="o">=</span>&gt; :unprocessable_entity <span class="o">}</span>
      end
    end
  end
  .
  .
  .
</code></pre>
</div>


<p>Now our controller looks a bit overweight. So, how could we solve this predicament? We need to respond to different mime requests, but at the same time we want our controllers thin. Ok, it's time for respond_with to come to the rescue.</p>

<p>First, we have to define which MIME responses our controller has to respond to. In this case, they are html and xml, so we have to define:</p>

<div class="highlight"><pre><code class="bash">class VariantsController &lt; ApplicationController
  respond_to :html, :xml
  .
  .
  .
  
</code></pre>
</div>


<p>Then, we will use respond_with to set the response, like follows:</p>

<div class="highlight"><pre><code class="bash">def index
  respond_with<span class="o">(</span>@variants <span class="o">=</span> Variant.all<span class="o">)</span>
end

def new
  respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.new<span class="o">)</span>
end

def create
  @variant <span class="o">=</span> Variant.create<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">])</span>
  flash<span class="o">[</span>:notice<span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Fortunately it was saved!&#39;</span> <span class="k">if</span> @user.save
  respond_with<span class="o">(</span>@variant<span class="o">)</span>
end
.
.
.
</code></pre>
</div>


<h2>So, when do I need to use respond_with?</h2>

<p>You need to use it when:</p>

<ul>
<li>You want your controllers to be as DRY as possible. Avoiding rewrite as much code as possible. Using the principle convention over configuration, you could simplify your controllers, and make them easy to maintain and read for others (and you as well).</li>
<li>When you have to respond to many different MIME requests. You can even customize your response_with. For example, you could add the same destination path to your responses adding :location as param:</li>
</ul>


<div class="highlight"><pre><code class="bash">def create
  respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.create<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">])</span>, :location <span class="o">=</span>&gt; variants_path<span class="o">)</span>
end
</code></pre>
</div>


<p>or, you could specify different actions for each response:</p>

<div class="highlight"><pre><code class="bash">def create
  respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.create<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">]))</span> <span class="k">do</span> |format|
    format.html
    format.xml <span class="o">{</span> render :xml <span class="o">=</span>&gt; @users <span class="o">}</span>
  end
end
</code></pre>
</div>


<p>If things get complicated when customizing a respond_with statement, I'd recommend that you stop customizing it and go back to the old configuration.</p>

<p>Other tool that plays very well with this new controllers feature is <a href="http://github.com/plataformatec/responders">responders</a>. Once you are using respond_with you might still be using manual flash (notice, alert) messages. But, with the responders gem you will use automatic response messages configured trough i18n. When you install this gem you will customize your flash messages using your local yml. All you have to do is install the gem:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>gem install responders

or, in your Gemfile

gem <span class="s1">&#39;responders&#39;</span>
</code></pre>
</div>


<p>and then, configure it through the appropriate generator:</p>

<div class="highlight"><pre><code class="bash">rails generate responders:install
</code></pre>
</div>


<p>You will see these changes:</p>

<div class="highlight"><pre><code class="bash">create  lib/application_responder.rb
prepend  app/controllers/application_controller.rb
inject  app/controllers/application_controller.rb
create  config/locales/responders.en.yml
</code></pre>
</div>


<p>what we will use is the last file "responders.en.yml", this file contains the messages for each action of the responders, and it looks like this:</p>

<div class="highlight"><pre><code class="bash">en:
  flash:
    actions:
      create:
        notice: <span class="s1">&#39;%{resource_name} was successfully created.&#39;</span>
      update:
        notice: <span class="s1">&#39;%{resource_name} was successfully updated.&#39;</span>
      destroy:
        notice: <span class="s1">&#39;%{resource_name} was successfully destroyed.&#39;</span>
        alert: <span class="s1">&#39;%{resource_name} could not be destroyed.&#39;</span>
</code></pre>
</div>


<p>You can manipulate this yml, following the i18n conventions, configuring notice messages or alert, or configure personalized messages for each resource, etc.</p>

<p>Ok, so, back to the controller, yo could define the create action as follows:</p>

<div class="highlight"><pre><code class="bash">def create
  respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.create<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">]))</span>
end
</code></pre>
</div>


<p>And this way you get everything, including the flash notice.</p>

<p>So, in the end, this could be your complete RESTFUL controller:</p>

<div class="highlight"><pre><code class="bash">class VariantsController &lt; ApplicationController
  respond_to :html

  def index
    respond_with<span class="o">(</span>@variants <span class="o">=</span> Variant.all<span class="o">)</span>
  end

  def new
    respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.new<span class="o">)</span>
  end

  def create
    respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.create<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">]))</span>
  end

  def edit
    respond_with<span class="o">(</span>@variant <span class="o">=</span> Variant.find<span class="o">(</span>params<span class="o">[</span>:id<span class="o">]))</span>
  end

  def update
    @variant <span class="o">=</span> Variant.find<span class="o">(</span>params<span class="o">[</span>:id<span class="o">])</span>
    respond_with<span class="o">(</span>@variant.update_attributes<span class="o">(</span>params<span class="o">[</span>:variant<span class="o">]))</span>
  end
  
  def destroy
    @variant <span class="o">=</span> Variant.find<span class="o">(</span>params<span class="o">[</span>:id<span class="o">])</span>
    @variant.destroy
    respond_with<span class="o">(</span>@variant<span class="o">)</span>
  end
  
end
</code></pre>
</div>


<h2>What else?</h2>

<p>Well, if you want to define a particular response by default, you could set it in your "routes.rb" like this:</p>

<div class="highlight"><pre><code class="bash">resources :variants, :defaults <span class="o">=</span>&gt; <span class="o">{</span>:action <span class="o">=</span>&gt; <span class="s2">&quot;index&quot;</span>, :format <span class="o">=</span>&gt; <span class="s2">&quot;xml&quot;</span><span class="o">}</span>
</code></pre>
</div>


<p>If you define a view for this format (for example: index.xml.haml) it will render it. If not, then it will invoke to_xml to render it.</p>

<p>Try to play with the new controllers behavior, it might surprise you. If you want to know more about respond_with you could visit <a href="http://ryandaigle.com/">Ryan Daigle's</a> posts, they are really helpful.</p>

    <div class="author_box">
      <p><b>Author:</b> Luis Galaviz | luis.galaviz@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2010/11/05/controller-responders-in-rails-3.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>

<div class="post prepend-1">
  <h1><a href="/2010/11/01/rack.html">Rack Introduction</a></h1>
  <p class="author">
    <span class="date"><b>Nov 01</b><br />2010</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/a302e7dd208f335dc67761a6db911561" class="avatar" alt="Avatar" /></div>
    <h1>Implementing Rack</h1>

<p>Rack provides a minimal interface between web servers supporting <strong>Ruby</strong>. It contains a full
stack of middleware components. Using <strong>Rack</strong> middleware you can build standalone applications that
can be plugged in Rails, Sinatra and many other <em>Rack based frameworks</em>.</p>

<p>Rack is one of those "bare minimum components" that you need for creating modular web
applications, furthermore, by learning Rack you begin mastering part of the <em>Rails internals</em>, why?,
because of <strong>Rails</strong> has adopted the <em>Rack philosophy</em> throughout its framework, a Rails application is actually
<em>a collection of Rack and Rails middleware components</em> that all work together to form the completed
whole.</p>

<p>In this article I'll guide you through the process of installing Rack, letting you know what every rack
application must implement/provide and creating a rack application, in the process I'll explain some
concepts with a design pattern interpretation of rack and finally we'll see an integrating example
of the whole story.</p>

<p>Let's begin.</p>

<h2>Installing Rack</h2>

<p>Just install the rack gem, as simple as:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">gem</span> <span class="n">install</span> <span class="n">rack</span>
</code></pre>
</div>


<h2>Basic requirements</h2>

<p>A Rack application is a <strong>Ruby object</strong> that <strong>respond_to? 'call'</strong>, it takes exactly <em>one argument</em>:
<strong>the environment</strong>, and <em>returns</em> an <strong>Array</strong> of exactly <strong>three values</strong>: <strong>http status</strong>, <strong>http
headers</strong>, and <strong>http body</strong>.</p>

<p>The headers and body returned by call have to <strong>respond_to? 'each'</strong>.</p>

<p>So basically anything like the following may act as a rack application:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">rack_app</span><span class="o">.</span><span class="n">call</span> <span class="n">environment</span>
</code></pre>
</div>


<p>Of course, there are more things that you need to check in order to make your application
<strong>Rack compliant</strong>, but we'll get to that later.</p>

<p>Now we are going to build a classic example application.</p>

<h2>Hello World example</h2>

<p>In this example, it returns a three element Array, array's elements in order are: 200 HTTP
successful response code, a text/html content type and the HTTP response body with a "Hello
World" message.</p>

<p>Open a file, call it <em>hello_world.ru</em>, and write following:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">app</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span> 
    <span class="o">[</span><span class="mi">200</span><span class="p">,</span> 
      <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span> <span class="p">},</span> 
     <span class="s1">&#39;Hello World&#39;</span><span class="o">]</span>
  <span class="k">end</span> 
  <span class="n">run</span> <span class="n">app</span> 
</code></pre>
</div>


<p>In order to run it, I'll first send the <em>rackup hello_world.ru</em> to background, next using <em>curl</em>
we'll send a request to localhost:</p>

<div class="highlight"><pre><code class="bash">  ..<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>rackup hello_world.ru &amp;
  <span class="o">[</span>1<span class="o">]</span> 12508
  ...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>curl localhost:9292
  127.0.0.1 - - <span class="o">[</span>05/Nov/2010 12:07:54<span class="o">]</span> <span class="s2">&quot;GET / HTTP/1.1&quot;</span> 200 - 0.0008
  Hello World
</code></pre>
</div>


<p>And there we have our <strong>Hello World</strong> message from the <em>http body</em> example.</p>

<h2>Basic API</h2>

<p>Before going on to the next examples, you need to know that rack applications usually call
following methods:</p>

<ul>
<li><em>use(middleware, **args, &amp;block)</em> adds a middleware to the stack</li>
<li><em>run(app)</em> dispatches to an application</li>
<li><em>map(path, &amp;block)</em> constructs a Rack::URLMap in a convenient way</li>
</ul>


<p>Next, I'll describe a rack basic concept and after that I'll show an example on how to stack
many rack applications.</p>

<h2>Middleware</h2>

<p>A middleware is a Rack application that is <em>designed</em> to <em>run</em> in <em>conjunction</em> with another Rack
application that acts as the <em>endpoint</em>.</p>

<p>Think of a Rack middleware as a filter <em>receiving</em> the Rack environment for the request
from the previous <em>middleware, then doing some work with or on the </em>request's environment<em>
and then </em>calling<em> the </em>next middleware<em> in the chain. The </em>last<em> Rack application in the
chain is the </em>application itself<em>, </em>any<em> middleware in the chain can </em>return the Rack response
itself<em>, thus </em>preventing<em> the rest of the middlewares in the chain from </em>executing*.</p>

<p>Now let's build and chain three rack applications/middlewares, one <em>lambda endpoint</em> and two <em>call</em>
responders: SayHi and SayNothing. After this example we'll go through how Rack integrates a
<em>design pattern</em>.</p>

<h2>Chaining Rack applications example</h2>

<p>Our endpoint application is just like the previous Hello World example but it returns an
"I'm an endpoint" body.</p>

<p>The point here is to show how three different objects (middlewares) are chained, classes
<em>SayHi</em> and <em>SayNothing</em> will simply append a message to the response body, in the end, the returned
request body will contain the message added by each middleware.</p>

<p>In order to avoid code repetition we'll define the common code that is inside the Initializer module
and then we'll mix it in each class using <strong>Module#include</strong>.</p>

<div class="highlight"><pre><code class="ruby">  <span class="k">module</span> <span class="nn">Initializer</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span> 
    <span class="k">end</span> 
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Hi from </span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="o">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="o">]</span>
    <span class="k">end</span> 
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">SayHi</span>
    <span class="kp">include</span> <span class="no">Initializer</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">SayNothing</span>
    <span class="kp">include</span> <span class="no">Initializer</span>
  <span class="k">end</span>
    
  <span class="n">use</span> <span class="no">SayHi</span>
  <span class="n">use</span> <span class="no">SayNothing</span>
  <span class="n">run</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">env</span><span class="o">|</span> <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">},</span> <span class="o">[</span><span class="s2">&quot;I&#39;m the endpoint&quot;</span><span class="o">]]</span> <span class="p">}</span>
</code></pre>
</div>


<p>Let's test it using <em>rackup</em>:</p>

<div class="highlight"><pre><code class="bash">...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>rackup  simple_stacked.ru  -p 1111 &amp;
<span class="o">[</span>1<span class="o">]</span> 19216

...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>curl localhost:1111
I<span class="err">&#39;</span>m the endpoint
Hi from SayNothing
Hi from SayHi...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>
</code></pre>
</div>


<p>The response shows the endpoint's message on the first line, plus the SayNothing response,
plus the SayHi response. As you can see all the applications interacted directly with the
request and its response.</p>

<h2>Decorator pattern</h2>

<p>It is important to note that Rack applications follow a decorator pattern, where each application
receives an <em>Array of three elements and returns an Array of three elements</em>, this Array must follow
the specification we discussed above.</p>

<p>This pattern allows components to receive/add behavior dynamically using a common interface. If
you want to learn more about the subject I recommend you go through <a href="http://lukeredpath.co.uk/blog/decorator-pattern-with-ruby-in-8-lines.html">Luke Redpath's excellent
article</a>.</p>

<p>The following gist intends to show a very basic decorator implementation <strong>MyBaseApp</strong>
that initializes with a three elements array mimicking a Rack Application, that application will be
decorated with HTML and JSON outputs:</p>

<script src="https://gist.github.com/668084.js"> </script>


<p>Given the dynamic nature of the Ruby language there are many ways to implement a decorator, you decide
which one fits your needs.</p>

<h2>Creating valid Rack applications</h2>

<p>Every Rack application must follow the <a href="http://rack.rubyforge.org/doc/SPEC.html">Rack Spec</a>,
Rack helps you to follow it by proving a <strong>Rack::Lint</strong> middleware, you should include it in your
application in order to make it <strong>Rack complain</strong>. By running your application using <strong>rackup</strong>
command line tool, you are already using it, otherwise include it with a:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lint</span>
</code></pre>
</div>


<p>Also, you may test your application with <a href="http://relishapp.com/rspec">RSpec</a>, the following is an
example I'm working on based on the Rack Spec:</p>

<script src="https://gist.github.com/668111.js"> </script>


<p>Now, let's implement and tie everything together with the next example:</p>

<h2>Static file server with Haml support example</h2>

<p>Imagine your application returns files from a certain folder, just like a file server, but,
whenever these files have a <a href="http://haml-lang.com/">Haml</a> extension they will be parsed and
rendered as html.</p>

<p>We'll do this in two steps, first we'll serve static files, second we'll parse haml files. Let's
start!.</p>

<h3>Step 1. Serving static files</h3>

<p>Create a <em>file_server.rb</em> file, and put following code in it:</p>

<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;rack/file&#39;</span>
  <span class="n">run</span> <span class="no">Rack</span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">))</span>
</code></pre>
</div>


<p>Now create a <em>public</em> folder and a <em>index.html</em> file inside and fill in this html file with:</p>

<div class="highlight"><pre><code class="html">  <span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
      <span class="nt">&lt;title&gt;</span>The index file<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
      The body
    <span class="nt">&lt;/body&gt;</span>
  <span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>


<p>Now let's test it using <em>rackup</em> and <em>curl</em>:</p>

<div class="highlight"><pre><code class="bash">  ...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>rackup file_server.ru -p 1111 &amp;
  <span class="o">[</span>2<span class="o">]</span> 17882

  ...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>curl localhost:1111
  File not found: /
  ...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>curl localhost:1111/index.html
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;The index file&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      The body
    &lt;/body&gt;
  &lt;/html&gt;
</code></pre>
</div>


<p>It works, now we have a static files server.</p>

<h3>Step 2. Serve haml files as html</h3>

<div class="highlight"><pre><code class="ruby">  <span class="nb">require</span> <span class="s1">&#39;rack/file&#39;</span>

  <span class="k">class</span> <span class="nc">MyHaml</span>
    <span class="nb">require</span> <span class="s1">&#39;haml&#39;</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/\.haml$/</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">parse_haml</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">to_s</span>
        <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span>
      <span class="k">end</span>

      <span class="o">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">parse_haml</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">full_body</span> <span class="o">=</span> <span class="n">traverse_body</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">engine</span> <span class="o">=</span> <span class="no">Haml</span><span class="o">::</span><span class="no">Engine</span><span class="o">.</span><span class="n">new</span> <span class="n">full_body</span>
      <span class="n">engine</span><span class="o">.</span><span class="n">render</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">traverse_body</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      <span class="n">body</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">text</span> <span class="o">&lt;&lt;</span> <span class="n">x</span><span class="p">}</span>
      <span class="n">text</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="n">use</span> <span class="no">MyHaml</span>
  <span class="n">run</span> <span class="no">Rack</span><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">))</span>
</code></pre>
</div>


<p>Our call method basically looks for request paths where the file name has a haml extension,
we have to change the content length and type to match what the response is returning,
here we are using <em>traverse_body</em> method just to read through the previous response body,
since it is a <em>Rack::File</em> instance.</p>

<p>In order to test this, create a <em>index.haml</em> file inside public folder and fill it in with
following:</p>

<div class="highlight"><pre><code class="html">  !!!
  %html
    %head
      %title The index from a haml file
    %body
      The haml body
</code></pre>
</div>


<p>Let's test it with <em>rackup</em> and <em>curl</em>:</p>

<div class="highlight"><pre><code class="bash">  ...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>rackup file_server.ru -p 1111 &amp;
  <span class="o">[</span>2<span class="o">]</span> 19132

  ...<span class="o">(</span>master<span class="o">)</span> <span class="nv">$ </span>curl  localhost:1111/index.haml
  &lt;!DOCTYPE html PUBLIC <span class="s2">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class="s2">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;The index from a haml file&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      The haml body
    &lt;/body&gt;
  &lt;/html&gt;
</code></pre>
</div>


<h2>Conclusion</h2>

<p>There's lot more to learn about, for example :</p>

<ul>
<li>Ruby and Rails integration</li>
<li>Ruby and Rails rack architecture</li>
<li>Lots of other Rack utilities</li>
</ul>


<p>I'll go through these examples in future articles, for now I think this is enough.
Feel free to send me your comments, additions, resources or complaints. I will certainly
look forward to them.</p>

<p>Thanks for your reading and remember, others sources codes are sometimes your best teachers.</p>

<p>Regards</p>

    <div class="author_box">
      <p><b>Author:</b> Emmanuel Delgado | emmanuel.delgado@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2010/11/01/rack.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>

<div class="post prepend-1">
  <h1><a href="/2010/11/01/ignoring-files-with-git.html">Ignoring files with Git</a></h1>
  <p class="author">
    <span class="date"><b>Nov 01</b><br />2010</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/554ca5879badb8dfd61f5ea7e54aef9e" class="avatar" alt="Avatar" /></div>
    <p>When you work on an application there are some files you do not really need in the project (eg. database files, logs, dynamic created files, etc.)</p>

<p>Fortunately our versioning system / best friend, Git, comes with the ability to ignore those files. All you have to do is include a file in one of your project folders with the name ".gitignore"</p>

<div class="highlight"><pre><code class="bash">touch .gitignore
</code></pre>
</div>


<p>On this file you can include those files you do not want to be tracked by git:</p>

<div class="highlight"><pre><code class="bash">some_file.rb
*.log
doc/**/*
public/images/system/**/*
</code></pre>
</div>


<p>As you see, you can include the file name or include wildcards to select several files.</p>

<p>Git by default ignores empty folders, so if your application requires a folder to exist, you just need to create a blank .gitignore file.</p>

<p>But what if you must include a file inside a folder among others you want to ignore? such as config files, or whatever. Then you may want to prevent git from ignoring those files:</p>

<div class="highlight"><pre><code class="bash">config/*
!config/a_special_file.rb
</code></pre>
</div>


<p>This will tell git to ignore all the files, except for the one that is marked with a bang (!).</p>

<p>I hope this is helpful for someone.</p>

    <div class="author_box">
      <p><b>Author:</b> Daniel Gayt√°n | daniel@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2010/11/01/ignoring-files-with-git.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>

<div class="post prepend-1">
  <h1>Recent Posts</h1>
  <ul class="archives">

  <li><span><b>05 Nov 2010</b></span> &raquo; <a href="/2010/11/05/controller-responders-in-rails-3.html">Controller responders in Rails 3</a></li>

  <li><span><b>01 Nov 2010</b></span> &raquo; <a href="/2010/11/01/rack.html">Rack Introduction</a></li>

  <li><span><b>01 Nov 2010</b></span> &raquo; <a href="/2010/11/01/ignoring-files-with-git.html">Ignoring files with Git</a></li>

  <li><span><b>27 Oct 2010</b></span> &raquo; <a href="/2010/10/27/working-with-postgresql-and-rails3.html">Working with PostgreSQL and Rails3</a></li>

  <li><span><b>22 Oct 2010</b></span> &raquo; <a href="/2010/10/22/improve-your-seo-with-a-sitemap.html">Improve your SEO with a sitemap</a></li>

  <li><span><b>18 Oct 2010</b></span> &raquo; <a href="/2010/10/18/magmarails-2010-was-a-success.html">Magma Rails 2010, a success!</a></li>

  <li><span><b>07 Oct 2010</b></span> &raquo; <a href="/2010/10/07/magma-rails.html">Magma Rails is just around the corner!</a></li>

  <li><span><b>28 Sep 2010</b></span> &raquo; <a href="/2010/09/28/negative-code.html">Negative Code</a></li>

  <li><span><b>22 Sep 2010</b></span> &raquo; <a href="/2010/09/22/first-contact-with-regular-expressions.html">First contact with regular expressions</a></li>

  <li><span><b>17 Sep 2010</b></span> &raquo; <a href="/2010/09/17/installing-gems-skipping-rdoc-and-ri.html">Installing gems skipping RDoc and RI</a></li>

  <li><span><b>10 Sep 2010</b></span> &raquo; <a href="/2010/09/10/customize-your-generators-workflow.html">Customize your Generators Workflow in Rails 3.0.0</a></li>

  <li><span><b>06 Sep 2010</b></span> &raquo; <a href="/2010/09/06/a-simple-way-to-setup-a-class-for-global-values.html">A simple way to setup a class for global values</a></li>

  <li><span><b>31 Aug 2010</b></span> &raquo; <a href="/2010/08/31/open-and-watch-specific-git-branches-using-gitx.html">Open and watch specific git branches using gitx</a></li>

  <li><span><b>26 Aug 2010</b></span> &raquo; <a href="/2010/08/26/thin-vs-unicorn.html">Benchmarking thin vs unicorn</a></li>

  <li><span><b>20 Aug 2010</b></span> &raquo; <a href="/2010/08/20/what-i-would-ve-loved-to-know-when-i-first-met-ruby.html">What I would've loved I had known when I first met Ruby</a></li>

  <li><span><b>17 Aug 2010</b></span> &raquo; <a href="/2010/08/17/use-a-project-specific-ruby-version-rvm.html">Use a project specific Ruby version with RVM</a></li>

  <li><span><b>13 Aug 2010</b></span> &raquo; <a href="/2010/08/13/fix-incompatibility-with-attachment-fu-and-acts-as-list.html">Improve performance between attachment_fu and acts_as_list</a></li>

  <li><span><b>06 Aug 2010</b></span> &raquo; <a href="/2010/08/06/our-git-workflow.html">Our git workflow</a></li>

  <li><span><b>02 Aug 2010</b></span> &raquo; <a href="/2010/08/02/instant-blog-using-jekyll-and-heroku.html">Instant blog using Jekyll and Heroku</a></li>

  <li><span><b>28 Jul 2010</b></span> &raquo; <a href="/2010/07/28/getting-started-with-rvm.html">Getting started with Ruby Version Manager (RVM)</a></li>

  </ul>
</div>

        </div>
        <div class="right-side span-5 last prepend-1">
          <h1><a href="/">Blog Home</a></h1>
<h1>About Crowd Interactive</h1>
<p class="append-1 about">Crowd Interactive is an American web design and development company that happens to work in Colima, Mexico... <a href="/about.html">Read More...</a></p>
<div id="writeSkribitHere"></div><script src="http://assets.skribit.com/javascripts/SkribitWidget.js?renderTo=writeSkribitHere&amp;blog=ef56d1750b6040b271e0080ef2886f3b&amp;cnt=5&noCSS=1"></script><noscript>Sorry, but the <a href="http://skribit.com" title="Skribit - Cure Writer's Block">Skribit</a> widget only works on browsers with JavaScript support.  <a href="http://skribit.com/blogs/crowdint-tech" title="Skribit Suggestions for Crowdint Tech">View suggestions for this blog here.</a></noscript>
<h1>Our Favorite Sites</h1>
<ul>
  <li><a href="http://www.crowdint.com">Crowd Interactive</a></li>
  <li><a href="http://www.magmarails.com">MagmaRails</a></li>
  <li><a href="http://rubyonrails.org">Ruby on Rails</a></li>
  <li><a href="http://ruby-lang.org">Ruby-Lang</a></li>
  <li><a href="http://github.com/crowdint">Github</a></li>
</ul>
<h1>Stuff we've built</h1>
<ul>
  <li><a href="http://www.modcloth.com">ModCloth</a></li>
  <li><a href="http://www.creativeallies.com">Creative Allies</a></li>
  <li><a href="http://www.nameframe.com">Nameframe</a></li>
  <li><a href="http://github.com/crowdint/rails3-jquery-autocomplete">Rails3-jQuery-Autocomplete</a></li>
  <li><a href="http://github.com/crowdint/rankstar">rankstar</a></li>
  <li><a href="http://github.com/crowdint/blog.crowdint.com">This site's source code</a></li>
</ul>
<h1>Older Posts</h1>
<ul>
  <li><a href="/archive.html">Archive</a></li>
</ul>

Site Powered by <a href="http://github.com/mojombo/jekyll">Jekyll</a>

        </div>
      </div>
      <div class="round-bottom span-24">
        &nbsp;
      </div>
    </div>

  </div>
  <div id="footer">
    <div class="copyContent" >
      <p class="copy">Copyright &copy; 2010, Crowd Interactive. All rights reserved.</p>
    </div>
  </div>
  <script type="text/javascript">
  var disqus_shortname = 'crowdinttech';
  (function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/crowdinttech/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
  </script>
</body>
</html>
